---
title:  "PriceParser или импорт прайс-листов в OpenCart"
date:   2013-12-30 03:07:00
tags:   ["opencart", "parsers"]
layout: "blog/post"
---

Причина того, что побудило меня браться за очередной велосипед к опенкарту, как всегда проста и незамысловата: существующие решения не отвечают нужным требованиям. Чтобы это понять, нам пришлось даже купить парочку коммерческих модулей для импорта прайс-листов. Все они сделаны в лучших традициях OpenCart — заточены под дефолтные таблицы и крайне неудобно расширяются.

<!-- cut -->

## Проблема

Удобство управления всей конфигурацией модуля из админки это конечно хорошо, но только для нормальных людей. Для разработчика же добавление нового поля в админку это ад и израиль: разобраться с чужим кодом, поправить вьюшку, поправить контроллер, поправить модель, в общем дорого и нудно. Был еще человек, что зашифровал свой модуль зендом, тут, сами понимаете, дела с расширением совсем плохи.

## Решение

Решение пришло внезапно. Оказалось, что идея работы с данными по схемам, которая используется во [второй версии Exchange1C]([[~8]]) — крайне удобная штука. Для тех, кто не знает, объясню наглядно, как это работает: у нас есть, отдельный на каждую таблицу в БД файлик, с описанием полей — это базовая схема от которй наследуются схемы для конкретного поставщика. Схема поставщика — те-же файлики, которые переопределяют нужные поля базовой схемы.

Свойства полей описывают некоторую логику обработки данных, в частности: перезаписывать или не перезаписывать поле в существующем товаре, номер колонки из прайс-листа, параметры пересчета числовых значений, параметры поиска и замены подстрок и тому-подобные вещи.

Если еще нагляднее, вот например у нас пример базовой схемы данных товара, содержащей параметры перезаписи существующих данных и дефолтное значение для случая если данных не будет.

```json
{
  "model": {
    "overwrite": true,
    "default": ""
  },
  "price": {
    "overwrite": true,
    "default": ""
  }
}
```

А вот схема для какого-нибудь прайса поставщика, в которой уже описаны номера колонок из прайса, в которых содержатся данные для конкретного поля. Для цены так-же указан фильтр пересчета, прибавляющий к существующему значению наценку в 40%.

```json
{
  "model": {
    "column": 1
  },
  "price": {
    "column": 6,
    "filters": [{
      "type": "recalculate",
      "percentage": true,
      "action": "+",
      "value": 40
    }]
  }
}
```

После инициализации класса, вместе с базовой и расширяющей схемой ему скармливается двухмерный массив данных, который парсер получит из импортируемого файла. Класс превратит этот массив в ассоциативный массив, с разложенными по полочкам данными прайса, который в свою очередь передается в модель опенкарта и, либо создает товар, либо обновляет его.

Как видно, добалвение нового поля, в случае нестандартных таблицы, изменение логики, добавление нового поставщика — дело 20 секунд. Что касается поддержки форматов файлов для импорта, тут все тоже довольно радужно. Форматы могут быть любые, был бы только драйвер для парсера, тот-же PHPExcel можно прикрутить за 5 минут. На момент написания поста в комплекте есть поддержка CSV и Excel XML 2003, остальных пока нет, ибо пока что они просто не были нужны.

## Текущий статус

На текущий момент функционал модуля довольно скуден, по этой-же причине он не публикуется в магазине дополнений. Однако свою работу в боевом проекте, под который модуль изначально писался, он выполняет прекрасно. Идей и хотелок много, по мере возможности все они будут потихоньку реализовываться. Вопросы, касающиеся установки, настройки, размещения файлов будут позже разобраны на специальной странице в лаборатории, как только все стаблилизируется. Исходники, как обычно, доступны на [GitHub](https://github.com/zenwalker/opencart-priceparser).

Чтобы никому лишний раз не всатвать, модуль не умеет: раскладывать прайс по частям в разные категории и скачивать картиники. Ну и скриншот для заманухи.

[![Opencart PriceParser](https://cloclo11.datacloudmail.ru/weblink/view/47dc4ba94111/priceparser.png)](https://cloclo11.datacloudmail.ru/weblink/view/47dc4ba94111/priceparser.png)
